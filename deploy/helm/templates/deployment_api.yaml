apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "bsw.fullname" . }}-api
  labels:
    {{- include "bsw.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: api
  template:
    metadata:
      labels:
        app.kubernetes.io/component: api
        {{- include "bsw.labels" . | nindent 8 }}
    spec:
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: default
      containers:
        - name: {{ .Chart.Name }}-api
          image: "{{ .Values.api.image.repository }}:{{ .Values.api.image.tag | default .Chart.AppVersion }}"
          command: ["python", "main.py"]
          imagePullPolicy: {{ .Values.api.image.pullPolicy }}
          env:
            - name: GPT_DEPLOYMENT_NAME
              value: {{ $.Values.api.llm.gpt.deploymentName | quote }}
            - name: GPT_API_VERSION
              value: {{ $.Values.api.llm.gpt.apiVersion | quote }}
            - name: GPT_ENDPOINT
              value: {{ $.Values.api.llm.gpt.endpoint | quote }}
            - name: GPT_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-llm-secrets
                  key: gpt-api-key
            - name: EMBEDDINGS_MODEL_NAME
              value: {{ $.Values.api.llm.gpt.embeddings.modelName | quote }}
            - name: EMBEDDINGS_API_VERSION
              value: {{ $.Values.api.llm.gpt.embeddings.apiVersion | quote }}
            - name: EMBEDDINGS_ENDPOINT
              value: {{ $.Values.api.llm.gpt.embeddings.endpoint | quote }}
            - name: EMBEDDINGS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-llm-secrets
                  key: gpt-embeddings-key
            - name: AZURE_STORAGE_CONNECTION_STRING
              valueFrom:
                secretKeyRef:
                  name: api-llm-secrets
                  key: azure-storage-connection-string
            - name: DEFAULT_LLM
              value: {{ $.Values.api.llm.default_llm | quote }}
            - name: MISTRAL_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-llm-secrets
                  key: mistral-api-key
            - name: VLAM_API_KEY
              valueFrom:
                secretKeyRef:
                  name: api-llm-secrets
                  key: vlam-api-key
            - name: MISTRAL_DEPLOYMENT_NAME
              value: {{ $.Values.api.llm.mistral.deploymentName | quote }}
            - name: HF_TOKEN
              valueFrom:
                secretKeyRef:
                  name: api-llm-secrets
                  key: huggingface-token
            - name: LOG_LEVEL
              value: {{ .Values.api.loglevel | quote }}
            - name: KEYCLOAK_URL
              value: {{ .Values.auth.keycloak.internalUrl | quote }}
            - name: KEYCLOAK_REALM
              value: {{ .Values.auth.keycloak.realm | quote }}
            - name: KEYCLOAK_CLIENT_ID
              value: {{ .Values.auth.keycloak.clientId | quote }}
            - name: KEYCLOAK_SERVER_URL
              value: {{ .Values.auth.keycloak.internalUrl | quote }}
            - name: KEYCLOAK_INTERNAL_URL
              value: {{ .Values.auth.keycloak.internalUrl | quote }}
            - name: KEYCLOAK_ISSUER
              value: {{ printf "%s/realms/%s" .Values.auth.keycloak.publicUrl .Values.auth.keycloak.realm | quote }}
            - name: ES_HOSTNAME
              value: "http://{{ include "bsw.fullname" . }}-elasticsearch:{{ .Values.elasticsearch.service.httpPort }}"
            {{- range .Values.api.env }}
            - name: {{ .name }}
              value: {{ .value | quote }}
            {{- end }}
          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
          startupProbe:
            httpGet:
              path: /system/health
              port: http
            initialDelaySeconds: 20
            periodSeconds: 15
            timeoutSeconds: 5
            failureThreshold: 40
          livenessProbe:
            httpGet:
              path: /system/health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 5
            successThreshold: 1
          readinessProbe:
            httpGet:
              path: /system/health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
            successThreshold: 1
