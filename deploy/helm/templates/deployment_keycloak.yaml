{{- if .Values.auth.keycloak.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "bsw.fullname" . }}-keycloak
  labels:
    app.kubernetes.io/component: keycloak
    {{- include "bsw.labels" . | nindent 4 }}
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/component: keycloak
      app.kubernetes.io/name: {{ include "bsw.name" . }}
  template:
    metadata:
      labels:
        app.kubernetes.io/component: keycloak
        {{- include "bsw.labels" . | nindent 8 }}
    spec:
      containers:
        - name: keycloak
          image: {{ default "quay.io/keycloak/keycloak:24.0.5" .Values.auth.keycloak.image }}
          args: ["start-dev", "--http-port=8081", "--import-realm", "--hostname-strict-https=true"]
          env:
            - name: KEYCLOAK_ADMIN
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin-secret
                  key: admin-user
            - name: KEYCLOAK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: keycloak-admin-secret
                  key: admin-password
            - name: KC_HOSTNAME
              value: "{{ .Values.auth.keycloak.ingress.host }}:8443"
            - name: KC_PROXY
              value: edge
            - name: KC_HOSTNAME_STRICT_HTTPS
              value: "true"
            - name: KC_DB
              value: dev-file
            - name: KC_FEATURES
              value: preview
            - name: KC_HEALTH_ENABLED
              value: "true"
            - name: KC_METRICS_ENABLED
              value: "true"
            - name: KC_HOSTNAME_STRICT
              value: "false"
          ports:
            - containerPort: 8081
              name: http
          volumeMounts:
            - name: keycloak-realms
              mountPath: /opt/keycloak/data/import
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 15
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 15
      volumes:
        - name: keycloak-realms
          configMap:
            name: {{ include "bsw.fullname" . }}-keycloak-realms
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "bsw.fullname" . }}-keycloak-realms
data:
  bsw-realm.json: |
    {
        "realm": {{ .Values.auth.keycloak.realm | quote }},
        "enabled": true,
        "sslRequired": "NONE",
        "registrationAllowed": false,
        "loginWithEmailAllowed": true,
        "duplicateEmailsAllowed": false,
        "resetPasswordAllowed": true,
        "editUsernameAllowed": true,
        "bruteForceProtected": true,
        "roles": {
            "realm": [{"name": "user"}, {"name": "admin"}]
        },
        "clients": [
            {
                "clientId": {{ .Values.auth.keycloak.clientId | quote }},
                "name": "BSW Frontend",
                "enabled": true,
                "publicClient": true,
                "protocol": "openid-connect",
                "redirectUris": [
                  "http://{{ .Values.frontend.ingress.host }}:8080/*",
                  "http://{{ .Values.frontend.ingress.host }}:8080/silent-check-sso.html",
                  "https://{{ .Values.frontend.ingress.host }}:8443/*",
                  "https://{{ .Values.frontend.ingress.host }}:8443/silent-check-sso.html"
                ],
                "webOrigins": [
                  "http://{{ .Values.frontend.ingress.host }}:8080",
                  "https://{{ .Values.frontend.ingress.host }}:8443"
                ],
                "standardFlowEnabled": true
            },
            {
                "clientId": "nextcloud-client",
                "name": "Nextcloud Integration",
                "enabled": true,
                "publicClient": true,
                "protocol": "openid-connect",
                "redirectUris": [
                  "http://{{ .Values.nextcloud.ingress.host }}:8080/*",
                  "http://{{ .Values.nextcloud.ingress.host }}:8080/index.php/apps/user_oidc/*"
                ],
                "webOrigins": [
                  "http://{{ .Values.nextcloud.ingress.host }}:8080"
                ],
                "standardFlowEnabled": true
            }
        ],
        "users": [
            {
                "username": "admin",
                "email": "admin@example.com",
                "enabled": true,
                "emailVerified": true,
                "firstName": "Admin",
                "lastName": "User",
                "credentials": [
                    {
                        "type": "password",
                        "value": "password",
                        "temporary": false
                    }
                ],
                "realmRoles": ["user"]
            }
        ]
    }

{{- end }}